# 羽球排場系統規則說明

## 核心規則

### 1. 基本原則

- **✅ 已實作**：四個人完全不能重複組合的規則（已取消）
- **✅ 已實作**：AB vs CD 兩隊等級相加差異必須在 ±1.5 範圍內（絕對規則）

### 2. 等級規則例外處理

**✅ 已實作**：當準備區的人配對無法遵守等級規則時，系統自動處理放寬組合標準

- 系統跳出通知：『即將單次放寬組合標準以利進行組隊』
- 只能按 OK，也只需按 OK
- 立即開始單次無視等級標準配對組合

## 排場邏輯

### 【情況一】場上 12 人，準備區 1-4 人 **✅ 已實作**

| 準備區人數 | 下場後處理                                     | 準備區優先序                                                                                                                    | 剛下場優先序                              | 實作狀態 |
| ---------- | ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------- | -------- |
| 1 人       | 4 人下場，準備區 1 人+剛下場的 4 取 3 → 上場   | 全上                                                                                                                            | 剛下場 4 人直接隨機取 3，依據等級分配組隊 | ✅ 完成  |
| 2 人       | 4 人下場，準備區 2 人+剛下場的 4 取 2 → 上場   | 全上                                                                                                                            | 剛下場 4 人直接隨機取 2，依據等級分配組隊 | ✅ 完成  |
| 3 人       | 4 人下場，準備區 3 取 2+剛下場的 4 取 2 → 上場 | (1) 等待輪次最高優先<br>(2) 若等待輪次皆相同，則以場次最低優先<br>(3) 若場次皆相同，則準備區 3 人直接隨機取 2，依據等級分配組隊 | 剛下場 4 人直接隨機取 2，依據等級分配組隊 | ✅ 完成  |
| 4 人       | 4 人下場，準備區 4 取 3+剛下場的 4 取 1 → 上場 | (1) 無視等待輪次，以場次最低優先<br>(2) 若場次皆相同，則準備區 4 人直接隨機取 3，依據等級分配組隊                               | 剛下場 4 人直接隨機取 1，依據等級分配組隊 | ✅ 完成  |

### 【情況二】場上 12 人，準備區 5-8+ 人 **✅ 已實作**

| 準備區人數 | 下場後處理                                     | 準備區優先序                                                                                                                                                                         | 剛下場優先序                                                              | 實作狀態 |
| ---------- | ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------- | -------- |
| 5 人       | 4 人下場，準備區 5 取 3+剛下場的 4 取 1 → 上場 | (1) 等待輪次最高優先<br>(2) 若等待輪次皆相同，則以場次最低優先<br>(3) 若場次皆相同，則準備區 5 人直接隨機取 3，依據等級分配組隊                                                      | (1) 場次最低優先<br>(2) 若場次皆相同，則剛下場 4 人則隨機依據等級分配組隊 | ✅ 完成  |
| 6 人       | 4 人下場，準備區 6 取 4 → 上場                 | (1) 等待輪次為「2 輪」優先，全部準備區的選手等待輪次不可高於 3<br>(2) 若等待輪次皆為 1 輪(含)以下，則以場次最低優先<br>(3) 若場次皆相同，則準備區 6 人直接隨機取 4，依據等級分配組隊 | 全下                                                                      | ✅ 完成  |
| 7 人       | 4 人下場，準備區 7 取 4 → 上場                 | (1) 等待輪次為「2 輪」優先，全部準備區的選手等待輪次不可高於 3<br>(2) 若等待輪次皆為 1 輪(含)以下，則以場次最低優先<br>(3) 若場次皆相同，則準備區 7 人直接隨機取 4，依據等級分配組隊 | 全下                                                                      | ✅ 完成  |
| 8+ 人      | 4 人下場，準備區 8+取 4 → 上場                 | (1) 先從等待輪次最高取 2<br>(2) 再從場次最低取 2                                                                                                                                     | 全下                                                                      | ✅ 完成  |

## 優先序詳細說明 **✅ 已實作**

### 準備區選手優先序

1. **第一優先**：等待輪次最高
2. **第二優先**：等待輪次相同時，場次最低優先
3. **第三優先**：等待輪次和場次都相同時，隨機選擇

### 剛下場選手優先序

1. **預備區人數少時（1-4 人）**：剛下場選手隨機選擇
2. **預備區 5 人時**：剛下場選手按場次最低優先
3. **預備區 6 人以上**：剛下場選手全部進入準備區等待

## 組隊配對原則 **✅ 已實作**

- 選出 4 人後，依據等級進行配對
- 確保 AB vs CD 兩隊等級相加差異在 ±1.5 範圍內
- 無法符合時觸發放寬標準機制

## 實作技術細節

### 主要函數

- `selectPlayersForMatch()`: 主選手選擇邏輯
- `selectPlayersScenarioOne()`: 情況一選手選擇
- `selectPlayersScenarioTwo()`: 情況二選手選擇
- `findOptimalCombination()`: 等級配對（±1.5 規則）
- `findOptimalCombinationRelaxed()`: 放寬標準配對

### 系統工作流程

1. 自動判斷準備區人數
2. 選擇對應的情況邏輯
3. 按優先序選出 4 位選手
4. 進行等級配對檢查
5. 成功則建立比賽，失敗則觸發放寬標準
6. 更新選手狀態和介面顯示

### 調試功能

- 完整的控制台日誌記錄
- 選手選擇過程追蹤
- 等級配對結果顯示

---

最後更新時間：2025 年 6 月 30 日
實作完成狀態：✅ 全部完成
最後修正時間：2025 年 6 月 30 日（修正情況一 4 人邏輯與情況二 6-7 人邏輯）
