# 翰林羽球排場系統規則文檔

最後更新：2025-07-23

## 一、系統概述

本系統用於管理多個羽球場地的選手輪替配對，確保所有選手都有公平的上場機會，並維持比賽的競爭性平衡。

## 二、選手狀態定義

### 2.1 選手狀態
- **比賽中 (Playing)**：正在場上比賽的選手
- **休息中 (Resting)**：已登記但暫時不參與排場的選手
- **準備區 (Ready)**：等待上場的選手，包含：
  - **剛下場 (justFinished)**：剛結束比賽的選手
  - **等待中**：在準備區等待的選手

### 2.2 關鍵屬性
- **等待輪次 (waitingTurns)**：選手在準備區等待的輪數
  - 0：剛下場或剛加入
  - 1：等待1輪
  - 2：等待2輪
  - 3+：等待3輪以上（系統應避免此情況）
- **場次 (matches)**：選手已完成的比賽場數

## 三、核心排場規則

### 3.1 規則優先順序（從高到低）

#### 規則0：強制處理規則 [最高優先級]
- **觸發條件**：任何選手等待超過3輪
- **執行邏輯**：
  - 等待超過3輪的選手必須立即上場
  - 如果超過4人，選等待最久的4人
  - 如果不足4人，全部選上並補充其他選手
- **目的**：防止選手等待時間過長

#### 規則1：等待2輪優先
- **觸發條件**：有選手等待2輪
- **執行邏輯**：
  - 先檢查場次是否相同
  - 場次不同：等待2輪的選手優先
  - 場次相同：進入規則3（等級配對）
- **目的**：平衡等待時間

#### 規則2：等待輪次檢查
- **觸發條件**：所有選手等待輪次都在1輪以下
- **執行邏輯**：進入規則3檢查場次
- **目的**：作為規則分流的檢查點

#### 規則3：場次相同時的等級配對
- **觸發條件**：選手場次相同
- **執行邏輯**：
  - 使用純等級配對（忽略等待輪次）
  - 兩隊等級總和差異必須 ≤ ±1.5
  - 使用 `findOptimalCombinationLevelOnly` 函數
- **目的**：在場次相同時確保比賽競爭性

### 3.2 選手選擇情況

#### 情況一：準備區1-4人（不含剛下場）
固定的選擇模式：
- **1人**：準備區1人全上 + 剛下場3人
- **2人**：準備區2人全上 + 剛下場2人
- **3人**：準備區前2人 + 剛下場2人
- **4人**：準備區前3人（按場次排序）+ 剛下場1人

#### 情況二：準備區5人以上（不含剛下場）
- **5人**：準備區前3人 + 剛下場1人
- **6-7人**：準備區4人，剛下場全下
  - 優先順序：等待3輪 > 等待2輪 > 場次最低
- **8+人**：先取等待輪次最高2人，再取場次最低2人

## 四、等級配對規則

### 4.1 標準配對（findOptimalCombination）
- 兩隊等級總和差異 ≤ ±1.5
- 考慮等待輪次（等待越久優先度越高）
- 嘗試三種配對方式找最佳組合

### 4.2 純等級配對（findOptimalCombinationLevelOnly）
- 只考慮等級平衡，完全忽略等待輪次
- 用於規則3（場次相同的情況）

### 4.3 放寬配對（findOptimalCombinationRelaxed）
- 當標準配對失敗時使用
- 無視等級差異限制
- 主要考慮等待輪次平衡

## 五、等待輪次管理

### 5.1 輪次更新時機
- 每次完成排場後更新所有準備區選手的等待輪次
- 剛下場選手：標記為 `justFinished`，等待輪次為0
- 下一輪更新時：`justFinished` → 等待1輪

### 5.2 輪次計算規則
- 剛下場（justFinished）：0輪
- 其他選手：每輪+1
- 上場選手：重置為0

## 六、已知問題與限制

### 6.1 重複配對問題
- **問題**：相同4人組合頻繁重複出現
- **原因**：
  1. 情況一的固定選擇比例
  2. 缺乏歷史記錄檢查機制
  3. 排序規則過於確定性

### 6.2 未使用的功能
- `rotationOffsets`：已定義但未使用
- `historyMatchesArr`：記錄歷史但不用於避免重複
- `lastPairings`：記錄配對但未用於檢查
- `pairingHistory`：存在但未實作

### 6.3 規則衝突
- 等待2輪優先 vs 場次相同時等級配對
- 當兩者同時滿足時，場次相同會覆蓋等待優先

## 七、系統流程圖

```
開始選擇4位選手
    ↓
[規則0] 檢查：有選手等待 > 3輪？
    是 → 強制選這些選手上場
    ↓ 否
檢查準備區人數（不含剛下場）
    ↓
├─ 1-4人：進入【情況一】
│   └─ 按固定比例選擇
│
└─ 5+人：進入【情況二】
    ↓
    [規則1] 有等待2輪的選手？
        ├─ 是 → 場次是否相同？
        │        ├─ 是 → [規則3] 純等級配對
        │        └─ 否 → 等待2輪優先
        │
        └─ 否 → [規則2] 等待都≤1輪？
                 └─ 是 → 場次是否相同？
                          ├─ 是 → [規則3] 純等級配對
                          └─ 否 → 按場次最低優先
```

## 八、改進建議

1. **實作歷史檢查機制**
   - 利用 `historyMatchesArr` 避免重複組合
   - 檢查最近N場比賽避免相同4人組合

2. **增加選擇隨機性**
   - 在固定比例中加入輪替偏移
   - 使用 `rotationOffsets` 打破固定模式

3. **統一配對邏輯**
   - 解決規則衝突問題
   - 明確定義各規則的優先順序

4. **優化等待管理**
   - 實作更靈活的等待輪次處理
   - 避免選手等待時間差異過大

## 九、版本歷史

- 2025-07-23：初始文檔建立，整理現有規則系統