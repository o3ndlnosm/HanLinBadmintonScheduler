# 翰林羽球排場系統 - 排場邏輯說明文件

## 目錄
1. [系統概述](#系統概述)
2. [核心排場邏輯](#核心排場邏輯)
3. [特殊機制](#特殊機制)
4. [已知問題與限制](#已知問題與限制)
5. [操作建議](#操作建議)

## 系統概述

### 選手狀態
系統中的選手有以下幾種狀態：
- **選手列表**：已登錄但未參與排場的選手
- **預備區**：準備上場的選手
- **場上**：正在比賽的選手
- **休息區**：暫時休息的選手

### 重要屬性
每位選手都有以下屬性：
- `name`：選手姓名
- `level`：技術等級（數字越高表示技術越好）
- `matches`：已完成的場次數
- `waitingTurns`：在預備區等待的輪數
- `justFinished`：剛下場標記
- `justJoinedReady`：剛加入預備區標記

## 核心排場邏輯

### 1. 基本配對原則

#### 1.1 等級差異限制
- 同隊兩位選手的等級總和應與對手隊伍接近
- 初始閾值為 1.5，找不到合適組合時逐步放寬至 2.1
- 確保比賽的競爭性和公平性

#### 1.2 配對歷史考量
- 系統記錄所有選手間的配對次數
- 優先選擇較少配對過的組合
- 避免相同的配對重複出現

### 2. 選手優先級排序

選手上場的優先級按以下順序考慮：

1. **剛下場標記**（最低優先級）
   - 標記為 `justFinished` 的選手會被排在最後
   - 防止選手連續上場

2. **等待輪數**（最高權重）
   - 等待輪數越多，優先級越高
   - 使用平方值加權，增強長時間等待選手的優先級

3. **場次數**
   - 場次數越少，優先級越高
   - 確保所有選手的參與機會均等

4. **技術等級**
   - 在其他條件相同時，考慮等級平衡

### 3. 等待輪數機制

#### 3.1 等待輪數增加規則
- 每次排場後，未被選中的選手等待輪數 +1
- 剛下場的選手等待輪數重置為 0
- 被選中上場的選手等待輪數重置為 0

#### 3.2 特殊狀態處理
- **剛下場**（justFinished）：等待輪數為 0，下一輪變為 1
- **剛加入**（justJoinedReady）：初始等待輪數為 0，不會立即增加

### 4. 組合優化算法

系統使用回溯算法尋找最佳的 4 人組合：

```javascript
評分公式 = 配對歷史頻率 + (等待輪數權重 × 5) + 等級差異
```

- 配對歷史頻率：越低越好（避免重複）
- 等待輪數：使用負值，等待越久分數越低（優先選擇）
- 等級差異：越小越好（確保公平性）

## 特殊機制

### 1. 交叉選擇機制

當系統檢測到固定循環（相同的選手組合重複出現）時，會啟動交叉選擇：

#### 觸發條件
- 非剛下場選手數量 ≤ 4 人
- 檢測到選手組合循環出現

#### 執行邏輯
1. 從預備區選擇等待最久的 2 名選手
2. 從剛下場選手中選擇場次最少的 2 名選手
3. 組合成新的對戰組合，打破固定循環

### 2. 最小比賽時間限制

- 原設計：比賽時間少於 1 分鐘不計入場次
- **現已移除**：所有比賽都計入場次，無論時長

### 3. 遞補機制

當場上選手按下「休息」時：
1. 該選手移至休息區
2. 系統自動從預備區選擇合適的替補選手
3. 優先選擇等級相近且場次較少的選手

## 已知問題與限制

### 1. 人數限制問題

#### 問題描述
- 當預備區人數少於 4 人時，無法進行排場
- 可能導致場地空置

#### 建議解決方案
- 保持預備區至少有 6-8 名選手
- 適時將休息區選手移回預備區

### 2. 固定組合循環

#### 問題描述
- 當選手人數較少（4-6人）時，容易形成固定的配對循環
- 某些選手可能持續等待無法上場

#### 現有對策
- 交叉選擇機制會自動啟動
- 系統會顯示提示訊息

### 3. 等級差異過大

#### 問題描述
- 當選手等級差異過大時，可能找不到平衡的組合
- 可能導致比賽一面倒

#### 建議解決方案
- 盡量維持選手等級在合理範圍內（建議最大差異不超過 3）
- 考慮手動調整配對

### 4. 剛下場標記管理

#### 潛在問題
- 在極端情況下，剛下場標記可能不正確
- 可能影響選手的排序優先級

#### 系統對策
- 定期清理過期的標記
- 在每次排場前進行狀態檢查

### 5. 等待時間過長

#### 問題描述
- 某些選手可能等待 3 輪以上才能上場
- 特別是在人數不均或等級差異大時

#### 視覺提示
- 等待 2 輪：藍色高亮顯示
- 等待 3 輪以上：更強烈的高亮顯示

## 操作建議

### 1. 最佳實踐

1. **維持適當人數**
   - 預備區保持 8-12 人最佳
   - 避免過多選手在休息區

2. **注意等級平衡**
   - 新增選手時考慮整體等級分布
   - 避免等級差異過大的情況

3. **定期檢查等待狀態**
   - 關注等待超過 2 輪的選手
   - 必要時手動調整

### 2. 特殊情況處理

1. **所有場地空置時**
   - 確保預備區有足夠選手（至少 4 人）
   - 檢查是否有選手卡在休息區

2. **出現固定循環提示時**
   - 系統會自動處理，無需手動干預
   - 可考慮增加更多選手參與

3. **選手持續無法上場時**
   - 檢查該選手的等級是否與其他人差異過大
   - 考慮手動安排或調整等級

### 3. 系統限制

1. **技術限制**
   - 最多支援 3 個場地同時進行
   - 每場比賽固定 4 人（雙打）

2. **邏輯限制**
   - 無法處理單打或 3 人比賽
   - 不支援預設固定搭檔

## 版本記錄

- **v1.0** (2024-01)：初始版本，基本排場功能
- **v1.1** (2024-01)：新增等待輪數機制，優化公平性
- **v1.2** (2024-01)：新增交叉選擇機制，解決固定循環問題
- **v1.3** (2024-01)：移除最小比賽時間限制，所有比賽都計入場次

---

最後更新：2024年1月